---
title: "pset3_steiner"
author: "erika steiner"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

In this problem set, we continue analyzing the FTP program, again
interpreting beliefs about the time limit as the treatment variable. The
goal will be to estimate the effect of a perceived time limit on
employment and welfare receipt, this time using a
difference-in-differences approach. All data and documentation can be
found on Canvas under Problem Set 1.

```{r setup, include=FALSE}

# load packages
library("haven")
library("tidyverse")
library("magrittr")
library('knitr')
library('kableExtra')
# library("stringr")
# library("stargazer")
# library("ivreg")

# get rid of scientific notation
options(scipen=999)
```

```{r data set up, echo = FALSE}
# import admin data
ftp_ar <- read_dta("ftp_ar.dta")
# import survey data
ftp_srv <- read_dta("ftp_srv.dta")

# create merged data set
# add treatment dummy equal to perceived subject to time limit
ftp_merged <- 
  # admin data set
  ftp_ar %>% 
  # filter out ftp_ar participants who did not participate in the survey
  # using sampleid per data documentation page 13
  filter(.$sampleid %in% (ftp_srv$sampleid)) %>% 
  # add new treatment dummy TLyes
  mutate(TLyes = 
    case_when(
      # 1 if believed subject to time limit
      fmi2 == 1 ~ 1,
      # 0 if did not or were not sure if subject to time limit
      fmi2 == 2 ~ 0,
      fmi2 == 8 ~ 0
    )
  ) %>% 
  # remove rows where TLyes = NA
  filter(!is.na(TLyes))
```

1.  *Find the means of quarterly employment for each quarter from 10
    quarters prior to RA to 19 quarters following RA (recall from the
    documentation that the quarter of random assignment, which would
    naturally be designated as quarter 0, is actually denoted as quarter
    1). Tabulate the number of observations that contribute to each of
    those means.*

```{r q1 mean employment}
# Find the means of quarterly employment for each quarter
ftp_merged %>% 
  # from 10 quarters prior to RA to 19 quarters following RA
  # remember that empq20 = quarter 19 because RA occurs in quarter 1
  select(c('emppq10':'empq17', 'empq18':'empq20')) %>% 
  # calculate the mean across selected columns
  summarise(across(everything(),
    # using list as we're doing multiple functions
    list(qemp_mean = ~ mean(.x, na.rm = TRUE),
         # and tabulating n used in means
         valid_n = ~ sum(!is.na(.x))
         )
    )) %>% 
  # make table readable
  pivot_longer(cols = everything(),
               # split quarter, mean, and n
               names_to = c("quarter", ".value"),
               # (.*) puts first part of string into quarter column
               # qemp_mean|valid_n selects values to pull for each new mean/n col
               names_pattern = "(.*)_(qemp_mean|valid_n)"
               ) %>% 
  # and pretty
  kable(col.names = c("Quarter", "Mean", "N"), caption = "Quarterly Employment Means") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))

# extra code for confirming data
# ftp_merged %>% 
#   # from 10 quarters prior to RA to 19 quarters following RA
#   # remember that empq20 = quarter 19 because RA occurs in quarter 1
#   select(c('emppq10':'empq17', 'empq18':'empq20')) %>% 
#   colMeans(., na.rm = TRUE)

# ftp_merged %>% 
#   # from 10 quarters prior to RA to 19 quarters following RA
#   # remember that empq20 = quarter 19 because RA occurs in quarter 1
#   select(c('emppq10':'empq17', 'empq18':'empq20')) %>%
#   summarise(across(everything(), ~ sum(is.na(.x))))

```

*What is the longest pre-period that you could analyze, ensuring that
you have data for everyone in the sample? The longest post-period? Refer
to this as the balanced sample period.*

There are 1149 people who responded to the survey question about time
limits. All pre-randomization quarters include 1149 non-NA observations,
as do all post-randomization quarters except for Quarter 19 (empq20).The
balanced sample period is thus from 10 quarters prior to RA to 18
quarters following RA.

2.  Reconfigure the data so you have one record per person per quarter.
    Compute mean employment rates by treatment status, before and after
    treatment. Treatment status is TLyes; the date of random assignment
    divides the sample period into before and after (consider the period
    of random assignment itself to be “after”).

```{r q2 mean}
# reconfigure the data so you have one record per person per quarter
# create a balanced sample period (remove empq20)

quarter_levels <- c("emppq10", "emppq9", "emppq8", "emppq7", "emppq6", "emppq5", "emppq4", "emppq3", "emppq2", "emppq1", "empq1", "empq2", "empq3", "empq4", "empq5", "empq6", "empq7", "empq8", "empq9", "empq10", "empq11", "empq12", "empq13", "empq14", "empq15", "empq16", "empq17", "empq18", "empq19")

qemp_rates <- ftp_merged %>% 
  # select columns needed for analyses, such as treatment status
  select(c("TLyes", 
           # employment quarters for balanced sample period only
           'emppq10':'empq17', 'empq18':'empq19')
         ) %>% 
  # pivot longer for easier manipulation
  pivot_longer(cols = -TLyes,
               names_to = "quarter",
               values_to = "employment") %>% 
  # convert quarter to factor for better ordering
  # group by treatment status and quarter
  group_by(TLyes, quarter) %>% 
  # calculate means for each treatment group and quarter
  summarise(mean = mean(employment, na.rm = TRUE),
            n = sum(!is.na(employment)),
            # ungroup
            .groups = "drop") %>% 
  # make table readable
  pivot_wider(names_from = TLyes,
              values_from = c(mean, n)) 

qemp_rates %>% 
  # factor quarters for ordering
  mutate(quarter = factor(quarter, levels = quarter_levels)) %>% 
  # mutate(
  #   quarter = str_replace(quarter, "emppq", "before-rand quarter "),
  #   quarter = str_replace(quarter, "empq", "post-rand quarter "),
  #   ) %>%
  arrange(quarter) %>% 
  kable(col.names = c("Quarter", "Control Mean", "Treatment Mean", "Control N", "Treatment N"), 
        caption = "Quarterly Employment by Treatment Status") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))


```

*Were employment rates similar between the treatment and control groups
prior to treatment?* Prior to treatment (emppq10:emppq1), the employment
rates between the treatment and control groups are similar.

```{r}

qemp_rates %>% 
  filter(quarter %in% c("emppq10", "emppq9", "emppq8", "emppq7", "emppq6", "emppq5", "emppq4", "emppq3", "emppq2", "emppq1")) %>% 
  select(mean_0, mean_1) %>% 
  corr()
  
  ggplot(aes(x = mean_0, y = mean_1)) +
  geom_point() +
  geom_smooth(method = lm)
```

3.  (a) Run a DD regression. The dependent variable should be quarterly
        employment status, and the explanatory variables should include
        person dummies, quarter dummies, and an interaction between
        TLyes and a post-treatment dummy. Be sure to restrict attention
        to the balanced sample period.
  

3. (b) Now run the same regression, clustering the standard errors by
    sampleid. Explain why the standard errors change the way they do.
    Which standard errors should you report?

3. (c) How do you interpret the coefficient on the interaction between
    TLyes and the post- treatment dummy?

<!-- -->

4.  

    (a) Construct a test for parallel pre-treatment trends. Do you
        reject the null hypothesis?

<!-- -->

(b) Plot the relevant results.
(c) Do your results imply that your estimator identifies the ATT?

<!-- -->

5.  Now implement the event-study estimator, that is, estimate
    period-specific treatment effects that vary freely over the
    post-treatment period. Plot the estimates. Are the period-specific
    estimates significant? If not, does this concern you? Explain.
6.  Compare the mean of the period-specific treatment effects from
    question 5 to the constant post-treatment effect from question 3.
    Are they similar? How would you test the hypothesis that they are
    the same?
7.  So far, we have acted as if all the treatment observations were
    treated at the same calendar time. In fact, treatment was assigned
    over a period of four quarters, as can be seen by tabulating the
    variable rarelqt. Explain briefly why this potentially poses a
    problem for the analysis above.
8.  To see how important this issue is in practice, re-estimate your
    event-study model using the Callaway-Sant’anna method. Note that
    rarelqt = 1 corresponds to 1994.II, that is, April-June
9.  Start by creating a variable showing which observations are first
    treated in each calendar quarter. Call it racalqt. Tabulate it and
    comment on the share of observations that is first assigned to
    treatment in each quarter.
10. Calculate ATT(g, t) for each value of g and t = 1994.II to 1997.II.
    How similar are the estimated effects of treatment for the four
    groups?
11. Now calculate and plot period-specific treatment effects in units of
    time relative to the treatment quarter, also known as elapsed time
    and denoted by e. Do this for e=1,...,8.
12. Compare these estimates to those you estimated in question 5. Would
    you say they are mostly similar, or mostly different? Pay particular
    attention to the estimates for e=1 to 4.
